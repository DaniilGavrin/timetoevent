name: Master CI/CD + Telegram

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
    types: [closed]

jobs:
  build-and-deploy:
    if: |
      github.event_name == 'push' || 
      (github.event.pull_request.merged == true && github.event_name == 'pull_request')
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.29.3'

    - name: Install dependencies
      run: flutter pub get

    - name: Generate APK filename
      id: apk_name
      run: |
        COMMIT_HASH=$(git rev-parse --short HEAD)
        PROJECT_NAME=$(grep '^name:' pubspec.yaml | awk -F': ' '{print $2}' | tr -d '\r')
        VERSION=$(grep '^version:' pubspec.yaml | awk -F': ' '{print $2}' | cut -d'+' -f1 | tr -d '\r')
        TIMESTAMP=$(date +"%Y%m%d-%H%M")
        
        if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
          IDENTIFIER="pr${GITHUB_EVENT_NUMBER}"
        else
          IDENTIFIER="build${GITHUB_RUN_NUMBER}"
        fi
        
        APK_NAME="${PROJECT_NAME}_v${VERSION}_${IDENTIFIER}_${TIMESTAMP}_${COMMIT_HASH}.apk"
        echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT

    - name: Build APK
      run: |
        flutter build apk --release --no-tree-shake-icons
        mv build/app/outputs/apk/release/app-release.apk build/app/outputs/apk/release/${{ steps.apk_name.outputs.apk_name }}

    - name: Upload APK to Telegram
      env:
        BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        # Путь к APK
        APK_PATH="build/app/outputs/apk/release/${{ steps.apk_name.outputs.apk_name }}"
        
        # Отправка файла через Telegram API
        curl -F document=@$APK_PATH "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument?chat_id=${CHAT_ID}"

        # Дополнительное сообщение
        MESSAGE="✅ Сборка успешна!%0A%0AПроект: ${PROJECT_NAME}%0AВерсия: ${VERSION}%0AФайл: ${{ steps.apk_name.outputs.apk_name }}"
        curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
          -d chat_id="${CHAT_ID}" \
          -d text="${MESSAGE}" \
          -d parse_mode="Markdown"